<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compost | V22 (Google Auth Implemented)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... (TUTTO IL TUO CSS RIMANE IDENTICO) ... */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        :root {
            --dark-bg: #1a1a1a;
            --glass-bg: rgba(30, 30, 30, 0.85);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-color: #f0f0f0;
            --text-muted: #ccc;
            --tesi-color: #00FFFF;
            --nota-color: #FF00FF;
            --utente-color: #ADFF2F;
            --autore-color: #FFA500; 
            --visited-color: #555;
            --google-blue: #4285F4;
            --error-color: #FF4136;
            --success-color: #3D9970;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--dark-bg);
            font-family: 'Inter', sans-serif; color: var(--text-color);
        }

        .hidden { display: none !important; }

        /* --- UI Layer --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1000;
        }
        .ui-layer > *, .auth-modal-overlay { pointer-events: auto; }

        /* --- Graph Container --- */
        #graph-container {
            width: 100%; height: 100%; position: absolute;
            top: 0; left: 0; z-index: 1; cursor: grab;
        }
        #graph-container:active { cursor: grabbing; }

        .link, .node-group { transition: opacity 0.3s ease-in-out; }
        .faded { opacity: 0.1; }
        .node {
            stroke: #fff; stroke-width: 1.5px; cursor: pointer;
            transition: filter 0.2s ease-in-out, color 0.3s ease;
        }
        .node:hover { filter: drop-shadow(0 0 10px currentColor); }
        .node.tesi { color: var(--tesi-color); }
        .node.nota { color: var(--nota-color); }
        .node.utente { color: var(--utente-color); }
        .node.autore { color: var(--autore-color); } 
        .node.visited { color: var(--visited-color); stroke: #999; }
        .node-label {
            fill: var(--text-muted); font-size: 10px; pointer-events: none;
            text-anchor: middle;
        }
        
        /* --- Pulsanti di Azione Principali (Top Right) --- */
        .main-actions {
            position: absolute; top: 20px; right: 20px;
            display: flex; gap: 10px; transition: transform 0.4s ease;
            align-items: center;
        }
        .action-btn {
            background-color: var(--glass-bg); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 8px 15px; border-radius: 8px;
            cursor: pointer; font-size: 14px; transition: background-color 0.2s;
        }
        .action-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
        #user-display {
            background-color: var(--glass-bg);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
        }

        /* --- Men√π Laterale --- */
        .sidebar {
            position: absolute; top: 0; left: 0; height: 100%;
            width: calc(100% / 5); max-width: 360px;
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color); transform: translateX(-100%);
            transition: transform 0.4s ease; padding: 70px 20px 20px 20px;
            box-sizing: border-box; display: flex; flex-direction: column; gap: 15px;
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-trigger-area {
            position: absolute; top: 0; left: 0; width: 30px; height: 100%;
        }
        .hamburger-icon {
            position: absolute; top: 20px; left: 20px; width: 24px; height: 20px;
            cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;
        }
        .hamburger-icon span { width: 100%; height: 2px; background-color: var(--text-color); transition: all 0.3s; }
        .sidebar-btn {
            background: none; border: none; color: var(--text-color); text-align: left;
            font-size: 16px; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%;
        }
        .sidebar-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
        .dropdown-content {
            display: none; padding-left: 10px; max-height: 150px;
            overflow-y: auto; overflow-x: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .dropdown-content::-webkit-scrollbar {
            display: none;
        }
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 4px; padding: 2px 0;
        }
        .history-item a {
            color: var(--text-muted); display: block; padding: 5px;
            text-decoration: none; cursor: pointer; flex-grow: 1;
            white-space: normal; word-break: break-word;
        }
        .history-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .delete-history {
            padding: 5px 8px; cursor: pointer; font-size: 20px; color: var(--text-muted);
            align-self: center;
        }
        .delete-history:hover { color: var(--text-color); }
        
        /* --- Controls for Simulation --- */
        .controls-section {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .control-group {
            margin-bottom: 10px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text-muted);
        }
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            border-radius: 2px;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--tesi-color);
            cursor: pointer;
            border-radius: 50%;
        }
        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--tesi-color);
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }


        /* --- Header Superiore --- */
        .top-header {
            position: absolute; top: 0; left: 0; width: 100%; height: 33vh;
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color); transform: translateY(-100%);
            transition: transform 0.4s ease; display: flex; align-items: center;
            justify-content: center; flex-direction: column; box-sizing: border-box;
        }
        .top-header.open { transform: translateY(0); }
        .top-header.open ~ .main-actions { transform: translateY(33vh); }
        .header-logo-trigger {
            position: absolute; top: 20px; left: 50%;
            transform: translateX(-50%); cursor: pointer;
            font-size: 20px; font-weight: bold; z-index: 1001;
            display: flex; align-items: center; gap: 8px;
        }
        .header-arrow {
            width: 24px; height: 24px; fill: var(--text-color); transition: transform 0.4s ease;
        }
        .header-logo-trigger.open .header-arrow {
            transform: rotate(180deg);
        }
        .header-content {
            position: relative; width: 100%; height: 100%; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .social-links {
            position: absolute; bottom: 20px; right: 20px; display: flex; gap: 15px;
        }
        .social-links a svg { width: 24px; height: 24px; fill: var(--text-color); transition: fill 0.2s; }
        .social-links a:hover svg { fill: #fff; }

        /* --- Window Management --- */
        #window-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 500;
        }
        .popup-window {
            position: absolute; background: var(--glass-bg);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); min-width: 250px; min-height: 150px;
            display: flex; flex-direction: column;
            overflow: hidden; pointer-events: auto;
            resize: both;
        }
        .popup-header {
            padding: 10px 15px; cursor: move;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .popup-title {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .popup-close {
            background: none; border: none; color: var(--text-color); font-size: 20px; cursor: pointer;
        }
        .popup-content {
            padding: 15px; flex-grow: 1; overflow-y: auto; line-height: 1.6;
        }
        .popup-content textarea, .popup-content input {
            width: 100%; background: transparent; border: none;
            color: var(--text-color); 
            font-family: 'Inter', sans-serif; font-size: 14px;
            box-sizing: border-box;
        }
        .popup-footer {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .popup-message {
            text-align: left;
            font-size: 14px;
            flex-grow: 1;
        }
        .popup-message.error { color: var(--error-color); }
        .popup-message.success { color: var(--success-color); }


        /* --- Window Collapse Button --- */
        .collapse-btn {
            position: absolute; bottom: 20px; right: 20px; width: 50px; height: 50px;
            background: var(--glass-bg); border: 1px solid var(--border-color);
            border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .collapse-btn svg { width: 24px; height: 24px; fill: var(--text-color); }
        .collapsed-windows-menu {
            position: absolute; bottom: 80px; right: 20px;
            background: var(--glass-bg); border-radius: 8px; padding: 5px; display: none;
        }
        .collapsed-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 10px; border-radius: 4px;
        }
        .collapsed-item-title {
            cursor: pointer; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .collapsed-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .close-collapsed { font-size: 18px; margin-left: 10px; cursor: pointer; }

        /* --- Auth Modals --- */
        .auth-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; align-items: center; justify-content: center;
            z-index: 2000;
        }
        .auth-modal-overlay.visible {
            display: flex;
        }
        .auth-modal-content {
            position: relative;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 30px 40px; border-radius: 12px;
            border: 1px solid var(--border-color);
            width: 100%; max-width: 400px; color: var(--text-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
        }
        .auth-modal-content h2 {
            margin-top: 0; margin-bottom: 25px;
        }
        .auth-modal-close {
            position: absolute; top: 10px; right: 15px;
            background: none; border: none; color: var(--text-muted);
            font-size: 28px; cursor: pointer;
        }
        .google-btn {
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 12px; margin-bottom: 20px;
            border-radius: 8px; background-color: var(--google-blue);
            color: white; border: none; font-size: 16px; cursor: pointer;
        }
        .google-btn svg {
            width: 20px; height: 20px; margin-right: 10px;
        }
        .divider {
            display: flex; align-items: center; text-align: center;
            color: var(--text-muted); margin: 20px 0;
        }
        .divider::before, .divider::after {
            content: ''; flex: 1; border-bottom: 1px solid var(--border-color);
        }
        .divider:not(:empty)::before { margin-right: .25em; }
        .divider:not(:empty)::after { margin-left: .25em; }
        .auth-form {
            display: flex; flex-direction: column; gap: 15px;
        }
        .form-group {
            display: flex; gap: 10px;
        }
        .form-group > * {
            flex: 1;
        }
        .auth-input, .auth-select {
            width: 100%;
            background-color: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-color);
            font-size: 14px;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .auth-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23f0f0f0' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
        .auth-select option {
            background: var(--dark-bg);
            color: var(--text-color);
        }
        .auth-input::placeholder { color: var(--text-muted); }
        .auth-modal-content textarea.auth-input {
            height: 150px;
            resize: vertical;
        }
        .auth-submit-btn {
            background-color: var(--tesi-color); color: var(--dark-bg);
            border: none; padding: 12px; border-radius: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        .auth-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            display: none; /* Nascosto di default */
        }
        .auth-message.error {
            background-color: rgba(255, 65, 54, 0.2);
            color: var(--error-color);
            display: block;
        }
        .auth-message.success {
            background-color: rgba(61, 153, 112, 0.2);
            color: var(--success-color);
            display: block;
        }

        /* Stili per la finestra Team & Contatti */
        .bio-section {
            text-align: left;
            margin-bottom: 20px;
            border-left: 2px solid var(--tesi-color);
            padding-left: 15px;
        }
        .bio-section h3 {
            margin: 0 0 5px 0;
            color: var(--text-color);
        }
        .bio-section p {
            margin: 0;
            color: var(--text-muted);
            line-height: 1.5;
        }
        .contact-section {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .contact-section a {
            color: var(--tesi-color);
            text-decoration: none;
            font-weight: bold;
        }
        .contact-section a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <div id="graph-container"></div>
    <div id="window-container"></div>
    
    <div class="ui-layer">
        <div class="sidebar" id="sidebar">
            <button class="sidebar-btn dropdown-toggle">Cronologia Letture</button>
            <div class="dropdown-content" id="history-content"></div>
            <button class="sidebar-btn dropdown-toggle">I Miei Contributi</button>
            <div class="dropdown-content" id="contrib-content"></div>
            <button class="sidebar-btn">Invita un'amic”ò</button>
            <button class="sidebar-btn" id="how-to-btn">How To</button>
            <button class="sidebar-btn" id="bug-report-btn">Segnala Bug</button>
            <div class="controls-section">
                <h2>Controlli Simulazione</h2>
                <div class="control-group">
                    <label for="repel-force">Forza Repulsiva</label>
                    <input type="range" min="100" max="1000" value="300" class="slider" id="repel-force">
                </div>
                <div class="control-group">
                    <label for="link-force">Forza Link</label>
                    <input type="range" min="0" max="1" step="0.01" value="0.1" class="slider" id="link-force">
                </div>
                <div class="control-group">
                    <label for="link-distance">Distanza Link</label>
                    <input type="range" min="50" max="300" value="150" class="slider" id="link-distance">
                </div>
            </div>
        </div>
        <div class="sidebar-trigger-area" id="sidebar-trigger-area"></div>
        <div class="hamburger-icon" id="hamburger-icon"><span></span><span></span><span></span></div>
        <div class="header-logo-trigger" id="header-logo-trigger">
            <span>compost</span>
            <svg class="header-arrow" viewBox="0 0 24 24"><path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" /></svg>
        </div>
        <div class="top-header" id="top-header">
            <div class="header-content">
                <h1>compost</h1>
                <button class="action-btn" id="team-btn">Team & Contatti</button>
                <div class="social-links">
                    <a href="#" aria-label="Youtube"><svg viewBox="0 0 24 24"><path d="M21.582,6.186c-0.23-0.86-0.908-1.538-1.768-1.768C18.267,4,12,4,12,4S5.733,4,4.186,4.418 c-0.86,0.23-1.538,0.908-1.768,1.768C2,7.733,2,12,2,12s0,4.267,0.418,5.814c0.23,0.86,0.908,1.538,1.768,1.768 C5.733,20,12,20,12,20s6.267,0,7.814-0.418c0.861-0.23,1.538-0.908,1.768-1.768C22,16.267,22,12,22,12S22,7.733,21.582,6.186z M9.9,15.584V8.416L15.4,12L9.9,15.584z"/></svg></a>
                    <a href="#" aria-label="Twitch"><svg viewBox="0 0 24 24"><path d="M4.53,3,3,4.53V19.47H6.73V22.5H8.6L10.47,20.6H14.2L21,13.8V3H4.53M9.6,15.33H7.73V8.6H9.6V15.33M14.2,15.33H12.33V8.6H14.2V15.33Z"/></svg></a>
                    <a href="#" aria-label="Instagram"><svg viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.2,5.2 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.2,5.2 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z"/></svg></a>
                </div>
            </div>
        </div>
        
        <div class="main-actions">
            <button class="action-btn" id="signup-btn">Sign Up</button>
            <button class="action-btn" id="login-btn">Log In</button>
            <button class="action-btn" id="contribute-btn">Contribuisci</button>
            <span id="user-display" class="hidden"></span>
            <button class="action-btn hidden" id="logout-btn">Logout</button>
        </div>

        <div class="collapse-btn" id="collapse-btn">
            <svg viewBox="0 0 24 24"><path d="M20 16V4H8V16H20M22 16A2 2 0 0 1 20 18H8A2 2 0 0 1 6 16V4A2 2 0 0 1 8 2H20A2 2 0 0 1 22 4V16M4 8H2V20A2 2 0 0 0 4 22H16V20H4V8Z" /></svg>
        </div>
        <div class="collapsed-windows-menu" id="collapsed-menu"></div>
    </div>
    
    <div id="signup-modal" class="auth-modal-overlay">
        <div class="auth-modal-content">
            <button class="auth-modal-close">&times;</button>
            <div id="signup-form-container">
                <h2>Crea un Account</h2>
                <a href="/api/auth/google" class="google-btn" style="text-decoration: none;">
                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.25,22C17.6,22 21.5,18.33 21.5,12.91C21.5,11.76 21.35,11.1 21.35,11.1V11.1Z"></path></svg>
                    Continua con Google
                </a>
                <div class="divider">o</div>
                <form class="auth-form" id="signup-form">
                    <input type="email" id="signup-email" class="auth-input" placeholder="Mail" required>
                    <input type="password" id="signup-password" class="auth-input" placeholder="Password" required>
                    <input type="password" id="signup-password-confirm" class="auth-input" placeholder="Ripeti Password" required>
                    <div class="form-group">
                        <select class="auth-select" id="birth-month" required>
                            <option value="">Mese</option>
                        </select>
                        <select class="auth-select" id="birth-year" required>
                            <option value="">Anno</option>
                        </select>
                    </div>
                    <button type="submit" class="auth-submit-btn">Sign Up</button>
                </form>
                <div id="signup-message" class="auth-message"></div>
            </div>
        </div>
    </div>

    <div id="login-modal" class="auth-modal-overlay">
        <div class="auth-modal-content">
            <button class="auth-modal-close">&times;</button>
            <h2>Accedi</h2>
            <a href="/api/auth/google" class="google-btn" style="text-decoration: none;">
                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.25,22C17.6,22 21.5,18.33 21.5,12.91C21.5,11.76 21.35,11.1 21.35,11.1V11.1Z"></path></svg>
                Accedi con Google
            </a>
            <div class="divider">o</div>
            <form class="auth-form" id="login-form">
                <input type="email" id="login-email" class="auth-input" placeholder="Mail" required>
                <input type="password" id="login-password" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-submit-btn">Log In</button>
            </form>
            <div id="login-message" class="auth-message"></div>
        </div>
    </div>

    <div id="team-modal" class="auth-modal-overlay">
        <div class="auth-modal-content">
            <button class="auth-modal-close">&times;</button>
            <h2>Team & Contatti</h2>
            <div class="bio-section">
                <h3>Giulia Rossi</h3>
                <p>Ricercatrice e designer dell'interazione, esplora come le metafore biologiche possano plasmare nuove forme di conoscenza digitale. La sua tesi √® il punto di partenza di questo progetto.</p>
            </div>
            <div class="bio-section">
                <h3>Marco Bianchi</h3>
                <p>Sviluppatore e artista generativo, specializzato in visualizzazione dati. Trasforma concetti complessi in esperienze interattive e organiche, dando vita alla rete micelica di Compost.</p>
            </div>
            <div class="contact-section">
                <p>Per comunicazioni e collaborazioni:</p>
                <a href="mailto:compost.comunicazione@gmail.com">compost.comunicazione@gmail.com</a>
            </div>
        </div>
    </div>
    
    <div id="bug-report-modal" class="auth-modal-overlay">
        <div class="auth-modal-content">
            <button class="auth-modal-close">&times;</button>
            <div id="bug-report-form-container">
                <h2>Segnala un Bug</h2>
                <p style="text-align: left; font-size: 14px; color: var(--text-muted); margin-bottom: 20px;">
                    Hai trovato un problema? Descrivi cosa √® successo nel modo pi√π dettagliato possibile. Grazie per il tuo aiuto!
                </p>
                <form class="auth-form" id="bug-report-form">
                    <textarea class="auth-input" placeholder="Descrivi il bug qui..." required></textarea>
                    <button type="submit" class="auth-submit-btn">Invia Segnalazione</button>
                </form>
            </div>
        </div>
    </div>


    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let fullGraphData = { nodes: [], links: [] };
            let isFirstVisit = true;
            let authToken = null;
            const visitedNodes = new Set();
            
            // FIX: Promise per sincronizzare il caricamento del grafo e dei dati utente
            let resolveGraphReady;
            const graphReadyPromise = new Promise(resolve => { resolveGraphReady = resolve; });

            // --- UI & WINDOW MANAGEMENT ---
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.getElementById('hamburger-icon');
            const triggerArea = document.getElementById('sidebar-trigger-area');
            
            hamburger.addEventListener('click', () => sidebar.classList.toggle('open'));
            triggerArea.addEventListener('mouseenter', () => sidebar.classList.add('open'));
            sidebar.addEventListener('mouseleave', () => sidebar.classList.remove('open'));

            document.querySelectorAll('.dropdown-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    const content = btn.nextElementSibling;
                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });

            const topHeader = document.getElementById('top-header');
            const headerTrigger = document.getElementById('header-logo-trigger');
            headerTrigger.addEventListener('click', () => {
                topHeader.classList.toggle('open');
                headerTrigger.classList.toggle('open');
            });
            
            const windowManager = {
                windows: new Map(),
                highestZ: 500,
                collapsedWindows: [],

                findOpenPosition: function(winWidth, winHeight) {
                    const existingRects = Array.from(this.windows.values()).map(w => w.element.getBoundingClientRect());
                    const margin = 20;
                    const step = 40;

                    for (let y = 80; y <= window.innerHeight - winHeight - margin; y += step) {
                        for (let x = 80; x <= window.innerWidth - winWidth - margin; x += step) {
                            const newRect = {
                                top: y, bottom: y + winHeight,
                                left: x, right: x + winWidth
                            };
                            let overlaps = false;
                            for (const rect of existingRects) {
                                if (newRect.left < rect.right && newRect.right > rect.left &&
                                    newRect.top < rect.bottom && newRect.bottom > rect.top) {
                                    overlaps = true;
                                    break;
                                }
                            }
                            if (!overlaps) {
                                return { x, y };
                            }
                        }
                    }
                    const openWindowsCount = this.windows.size;
                    return { x: 50 + (openWindowsCount % 5) * 40, y: 80 + (openWindowsCount % 5) * 40 };
                },
                
                createWindow: function(options) {
                    const id = options.id || `window-${Date.now()}`;
                    if (this.windows.has(id)) {
                        this.focusWindow(id);
                        return;
                    }

                    const win = document.createElement('div');
                    win.className = 'popup-window';
                    win.id = id;

                    const initialSize = 350;
                    win.style.width = `${initialSize}px`;
                    win.style.height = `${initialSize}px`;

                    const pos = this.findOpenPosition(initialSize, initialSize);
                    win.style.left = `${pos.x}px`;
                    win.style.top = `${pos.y}px`;
                    win.style.zIndex = ++this.highestZ;

                    let contentHtml = `<p>${options.content}</p>`;
                    if (options.type === 'contribute') {
                        contentHtml = `
                            <form id="contribute-form">
                                <input type="text" class="auth-input" placeholder="Titolo del contributo" required style="margin-bottom: 10px; border: 1px solid var(--border-color); padding: 8px; border-radius: 4px;">
                                <textarea class="auth-input" placeholder="Scrivi il tuo contributo qui... [[collegamento]]" required style="height: 150px; border: 1px solid var(--border-color); padding: 8px; border-radius: 4px; resize: vertical;"></textarea>
                            </form>
                        `;
                    }

                    win.innerHTML = `
                        <div class="popup-header">
                            <span class="popup-title">${options.title}</span>
                            <button class="popup-close">&times;</button>
                        </div>
                        <div class="popup-content">${contentHtml}</div>
                        <div class="popup-footer">
                            <div class="popup-message"></div>
                            ${options.type === 'contribute' ? '<button class="action-btn">Pubblica</button>' : ''}
                        </div>
                    `;
                    
                    document.getElementById('window-container').appendChild(win);
                    this.windows.set(id, { element: win, options });
                    this.makeDraggable(win);
                    this.addEventListeners(win, id);

                    if (options.type === 'contribute') {
                        win.querySelector('.action-btn').addEventListener('click', () => handleContributionSubmit(win));
                    }
                },

                addEventListeners: function(win, id) {
                    win.querySelector('.popup-close').addEventListener('click', () => this.closeWindow(id));
                    win.addEventListener('mousedown', () => this.focusWindow(id));
                },

                closeWindow: function(id) {
                    const winData = this.windows.get(id);
                    if (winData) {
                        winData.element.remove();
                        this.windows.delete(id);
                        const abstractNode = fullGraphData.nodes.find(n => n.type === 'tesi' && n.id.toLowerCase().includes('abstract'));
                        if (abstractNode && id === abstractNode.id && isFirstVisit) {
                            expandGraph();
                            isFirstVisit = false;
                        }
                    }
                },

                focusWindow: function(id) {
                    const winData = this.windows.get(id);
                    if (winData) {
                        winData.element.style.zIndex = ++this.highestZ;
                    }
                },
                
                makeDraggable: function(element) {
                    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                    const header = element.querySelector(".popup-header");
                    if (header) {
                        header.onmousedown = dragMouseDown;
                    }

                    function dragMouseDown(e) {
                        e = e || window.event;
                        e.preventDefault();
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        document.onmouseup = closeDragElement;
                        document.onmousemove = elementDrag;
                    }

                    function elementDrag(e) {
                        e = e || window.event;
                        e.preventDefault();
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        
                        let newTop = element.offsetTop - pos2;
                        let newLeft = element.offsetLeft - pos1;

                        if (newTop < 0) newTop = 0;
                        if (newLeft < 0) newLeft = 0;
                        if (newTop + element.offsetHeight > window.innerHeight) newTop = window.innerHeight - element.offsetHeight;
                        if (newLeft + element.offsetWidth > window.innerWidth) newLeft = window.innerWidth - element.offsetWidth;

                        element.style.top = newTop + "px";
                        element.style.left = newLeft + "px";
                    }


                    function closeDragElement() {
                        document.onmouseup = null;
                        document.onmousemove = null;
                    }
                },

                collapseAll: function() {
                    this.windows.forEach((winData, id) => {
                        this.collapsedWindows.push({ ...winData.options, id });
                        winData.element.remove();
                    });
                    this.windows.clear();
                    this.updateCollapsedMenu();
                },

                restoreWindow: function(id) {
                    const winIndex = this.collapsedWindows.findIndex(w => w.id === id);
                    if (winIndex > -1) {
                        const winData = this.collapsedWindows.splice(winIndex, 1)[0];
                        this.createWindow(winData);
                    }
                    this.updateCollapsedMenu();
                },
                
                removeCollapsed: function(id) {
                    this.collapsedWindows = this.collapsedWindows.filter(w => w.id !== id);
                    this.updateCollapsedMenu();
                },

                updateCollapsedMenu: function() {
                    const menu = document.getElementById('collapsed-menu');
                    menu.innerHTML = '';
                    if (this.collapsedWindows.length === 0) {
                        menu.style.display = 'none';
                        return;
                    }
                    this.collapsedWindows.forEach(winData => {
                        const item = document.createElement('div');
                        item.className = 'collapsed-item';
                        
                        const titleEl = document.createElement('span');
                        titleEl.className = 'collapsed-item-title';
                        titleEl.textContent = winData.title;
                        titleEl.onclick = () => this.restoreWindow(winData.id);

                        const closeEl = document.createElement('span');
                        closeEl.className = 'close-collapsed';
                        closeEl.innerHTML = '&times;';
                        closeEl.onclick = () => this.removeCollapsed(winData.id);

                        item.appendChild(titleEl);
                        item.appendChild(closeEl);
                        menu.appendChild(item);
                    });
                }
            };
            
            async function updateHistory(nodeData) {
                if (visitedNodes.has(nodeData.id)) return;
                visitedNodes.add(nodeData.id);
                
                if (authToken) {
                    try {
                        await fetch('http://localhost:3000/api/me/history', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify({ nodeId: nodeData.id })
                        });
                    } catch (error) {
                        console.error("Errore nel salvare la cronologia:", error);
                    }
                }
                
                populateHistoryUI();
                d3.select(d3.selectAll('.node-group').filter(d => d.id === nodeData.id).node()).select('.node').classed('visited', true);
            }

            function populateHistoryUI() {
                const historyContent = document.getElementById('history-content');
                historyContent.innerHTML = '';
                visitedNodes.forEach(nodeId => {
                    const nodeData = fullGraphData.nodes.find(n => n.id === nodeId);
                    if (!nodeData) return;

                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    const link = document.createElement('a');
                    link.textContent = nodeData.id;
                    link.onclick = () => {
                        windowManager.createWindow({ id: nodeData.id, title: nodeData.id, content: nodeData.content });
                    };

                    historyItem.appendChild(link);
                    historyContent.appendChild(historyItem);
                });
            }

            function populateContributionsUI(contributions) {
                const contribContent = document.getElementById('contrib-content');
                contribContent.innerHTML = '';
                if (contributions.length === 0) {
                    contribContent.innerHTML = '<p style="padding: 5px; color: var(--text-muted);">Nessun contributo ancora.</p>';
                } else {
                    contributions.forEach(node => {
                        const contribItem = document.createElement('div');
                        contribItem.className = 'history-item';
                        const link = document.createElement('a');
                        link.textContent = `${node.title} (${node.status})`;
                        link.onclick = () => {
                                windowManager.createWindow({ id: node.title, title: node.title, content: node.content });
                        };
                        contribItem.appendChild(link);
                        contribContent.appendChild(contribItem);
                    });
                }
            }
            
            // --- AUTH LOGIC ---
            const signUpBtn = document.getElementById('signup-btn');
            const logInBtn = document.getElementById('login-btn');
            const teamBtn = document.getElementById('team-btn');
            const bugReportBtn = document.getElementById('bug-report-btn');
            const contributeBtn = document.getElementById('contribute-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');

            const signUpModal = document.getElementById('signup-modal');
            const logInModal = document.getElementById('login-modal');
            const teamModal = document.getElementById('team-modal');
            const bugReportModal = document.getElementById('bug-report-modal');

            signUpBtn.addEventListener('click', () => signUpModal.classList.add('visible'));
            logInBtn.addEventListener('click', () => logInModal.classList.add('visible'));
            teamBtn.addEventListener('click', () => teamModal.classList.add('visible'));
            bugReportBtn.addEventListener('click', () => bugReportModal.classList.add('visible'));
            
            contributeBtn.addEventListener('click', () => {
                if (!authToken) {
                    logInModal.classList.add('visible');
                    return;
                }
                windowManager.createWindow({
                    id: 'contribute-window', 
                    title: 'Nuovo Contributo', 
                    type: 'contribute'
                });
            });

            logoutBtn.addEventListener('click', () => {
                authToken = null;
                localStorage.removeItem('jwtToken'); // Rimuovi anche da localStorage
                visitedNodes.clear(); // FIX: Svuota la cronologia locale
                populateHistoryUI(); // FIX: Aggiorna l'UI della cronologia
                populateContributionsUI([]); // FIX: Svuota l'UI dei contributi
                d3.selectAll('.node').classed('visited', false); // FIX: Resetta il colore dei nodi
                updateUIAfterAuth();
            });

            function updateUIAfterAuth() {
                const loggedIn = !!authToken;
                signUpBtn.classList.toggle('hidden', loggedIn);
                logInBtn.classList.toggle('hidden', loggedIn);
                logoutBtn.classList.toggle('hidden', !loggedIn);
                userDisplay.classList.toggle('hidden', !loggedIn);

                if (loggedIn) {
                    const payload = JSON.parse(atob(authToken.split('.')[1]));
                    userDisplay.textContent = payload.user.email;
                    fetchUserData();
                }
            }

            async function fetchUserData() {
                if (!authToken) return;
                try {
                    // FIX: Attende che il grafo sia pronto prima di procedere
                    await graphReadyPromise;

                    const historyRes = await fetch('http://localhost:3000/api/me/history', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const historyData = await historyRes.json();
                    visitedNodes.clear(); // Pulisci prima di ripopolare
                    historyData.forEach(nodeId => visitedNodes.add(nodeId));
                    populateHistoryUI();
                    d3.selectAll('.node-group').select('.node').classed('visited', d => visitedNodes.has(d.id));

                    const contribRes = await fetch('http://localhost:3000/api/me/contributions', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const contribData = await contribRes.json();
                    populateContributionsUI(contribData);

                } catch (error) {
                    console.error("Errore nel caricare i dati utente:", error);
                }
            }

            function setupAuthModal(modal) {
                const closeBtn = modal.querySelector('.auth-modal-close');
                closeBtn.addEventListener('click', () => modal.classList.remove('visible'));
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('visible');
                    }
                });
            }
            setupAuthModal(signUpModal);
            setupAuthModal(logInModal);
            setupAuthModal(teamModal);
            setupAuthModal(bugReportModal);

            const monthSelect = document.getElementById('birth-month');
            const yearSelect = document.getElementById('birth-year');
            for (let i = 1; i <= 12; i++) { monthSelect.innerHTML += `<option value="${i}">${i}</option>`; }
            for (let i = 2025; i >= 1930; i--) { yearSelect.innerHTML += `<option value="${i}">${i}</option>`; }

            const signUpForm = document.getElementById('signup-form');
            const signupMessageEl = document.getElementById('signup-message');

            signUpForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                signupMessageEl.className = 'auth-message';
                signupMessageEl.textContent = '';
                
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const passwordConfirm = document.getElementById('signup-password-confirm').value;

                if (password !== passwordConfirm) {
                    signupMessageEl.textContent = 'Le password non coincidono.';
                    signupMessageEl.classList.add('error');
                    return;
                }

                try {
                    const response = await fetch('http://localhost:3000/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Errore di registrazione.');
                    
                    document.getElementById('signup-form-container').innerHTML = `
                        <h2>Registrazione Avvenuta!</h2>
                        <p>${data.message} Ora puoi effettuare il login.</p>`;
                } catch (error) {
                    signupMessageEl.textContent = error.message;
                    signupMessageEl.classList.add('error');
                }
            });
            
            const loginForm = document.getElementById('login-form');
            const loginMessageEl = document.getElementById('login-message');

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginMessageEl.className = 'auth-message';
                loginMessageEl.textContent = '';

                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                try {
                    const response = await fetch('http://localhost:3000/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Errore di login.');
                    
                    authToken = data.token;
                    localStorage.setItem('jwtToken', authToken); // Salva anche per Google
                    updateUIAfterAuth();
                    logInModal.classList.remove('visible');
                } catch (error) {
                    loginMessageEl.textContent = error.message;
                    loginMessageEl.classList.add('error');
                }
            });

            // NUOVA IMPLEMENTAZIONE GOOGLE LOGIN
            /**
             * Controlla se l'URL contiene un token JWT (proveniente dal login con Google),
             * lo salva e aggiorna l'interfaccia.
             */
            function handleGoogleAuthCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('token')) {
                    const token = urlParams.get('token');
                    authToken = token; // Imposta il token globale
                    localStorage.setItem('jwtToken', token); // Salvalo per coerenza
                    console.log('Token JWT ricevuto da Google e salvato.');

                    // Pulisci l'URL
                    window.history.replaceState({}, document.title, window.location.pathname);

                    // Aggiorna l'UI usando la stessa funzione del login normale
                    updateUIAfterAuth();
                    
                    // Chiudi eventuali modal di login aperti
                    logInModal.classList.remove('visible');
                    signUpModal.classList.remove('visible');
                }
            }


            const bugReportForm = document.getElementById('bug-report-form');
            const bugReportFormContainer = document.getElementById('bug-report-form-container');
            bugReportForm.addEventListener('submit', (e) => {
                e.preventDefault();
                bugReportFormContainer.innerHTML = '<h2>Grazie!</h2><p>La tua segnalazione √® stata inviata. Apprezziamo il tuo contributo per migliorare Compost.</p>';
            });

            document.getElementById('how-to-btn').addEventListener('click', () => windowManager.createWindow({id: 'how-to', title: 'How To', content: 'Per contribuire...'}));
            
            async function handleContributionSubmit(win) {
                const title = win.querySelector('input[type="text"]').value;
                const content = win.querySelector('textarea').value;
                const messageEl = win.querySelector('.popup-message');
                messageEl.textContent = '';
                messageEl.className = 'popup-message';

                if (!title || !content) {
                    messageEl.textContent = 'Titolo e contenuto sono obbligatori.';
                    messageEl.classList.add('error');
                    return;
                }
                
                try {
                    const response = await fetch('http://localhost:3000/api/nodes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ title, content })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Errore durante l\'invio.');

                    messageEl.textContent = data.message;
                    messageEl.classList.add('success');
                    
                    fetchUserData(); 

                    setTimeout(() => {
                        windowManager.closeWindow(win.id);
                    }, 2000);
                    
                } catch(error) {
                    messageEl.textContent = `Errore: ${error.message}`;
                    messageEl.classList.add('error');
                }
            }

            // --- D3 GRAPH LOGIC ---
            let currentNodes = [];
            let currentLinks = [];
            
            const container = d3.select('#graph-container');
            let width = container.node().clientWidth;
            let height = container.node().clientHeight;
            const svg = container.append("svg").attr("viewBox", [-width / 2, -height / 2, width, height]);
            const g = svg.append("g");
            
            const simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(d => d.id))
                .force("charge", d3.forceManyBody())
                .force("center", d3.forceCenter(0, 0))
                .force("collide", d3.forceCollide()); 

            let link = g.append("g").attr("class", "links").selectAll("line"); 
            let nodeGroup = g.append("g").selectAll("g");
            let radiusScale; 

            async function initializeGraph() {
                try {
                    const response = await fetch('http://localhost:3000/api/graph');
                    if (!response.ok) throw new Error(`Errore HTTP: ${response.status}`);
                    
                    const dataFromAPI = await response.json();

                    const validNodesFromAPI = dataFromAPI.nodes.filter(node => node.title);
                    const idToTitleMap = new Map(validNodesFromAPI.map(node => [node.id, node.title]));
                    const formattedNodes = validNodesFromAPI.map(node => ({
                        id: node.title,
                        content: node.content,
                        type: node.type
                    }));
                    const formattedLinks = dataFromAPI.links
                        .map(link => ({
                            source: idToTitleMap.get(link.source),
                            target: idToTitleMap.get(link.target)
                        }))
                        .filter(link => link.source && link.target); 
                    fullGraphData = { nodes: formattedNodes, links: formattedLinks };
                    setupGraphSimulation();
                    resolveGraphReady(); // FIX: Segnala che il grafo √® pronto
                } catch (error) {
                    console.error("Impossibile caricare i dati del grafo:", error);
                }
            }

            function setupGraphSimulation() {
                const nodeDegrees = {};
                fullGraphData.links.forEach(link => {
                    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                    nodeDegrees[sourceId] = (nodeDegrees[sourceId] || 0) + 1;
                    nodeDegrees[targetId] = (nodeDegrees[targetId] || 0) + 1;
                });
                fullGraphData.nodes.forEach(node => {
                    node.degree = nodeDegrees[node.id] || 0;
                });

                radiusScale = d3.scaleSqrt().domain([0, d3.max(fullGraphData.nodes, d => d.degree)]).range([8, 25]);
                simulation.force("collide").radius(d => radiusScale(d.degree) + 10);
                
                const abstractNode = fullGraphData.nodes.find(n => n.type === 'tesi' && n.id.toLowerCase().includes('abstract'));
                if (isFirstVisit && abstractNode) {
                    windowManager.createWindow({ id: abstractNode.id, title: abstractNode.id, content: abstractNode.content });
                    currentNodes = [abstractNode];
                    currentLinks = [];
                    updateGraph(currentNodes, currentLinks);
                } else {
                    currentNodes = fullGraphData.nodes;
                    currentLinks = fullGraphData.links;
                    updateGraph(currentNodes, currentLinks);
                }
                setupSimulationControls();
            }

            function updateGraph(nodes, links) {
                const abstractNode = fullGraphData.nodes.find(n => n.type === 'tesi' && n.id.toLowerCase().includes('abstract')) || {x: 0, y: 0};
                
                nodes.forEach(node => {
                    if (!node.x) {
                        node.x = abstractNode.x || 0;
                        node.y = abstractNode.y || 0;
                    }
                });
                
                nodeGroup = nodeGroup.data(nodes, d => d.id).join(
                    enter => {
                        const g = enter.append("g").attr("class", "node-group").attr("transform", d => `translate(${d.x},${d.y})`).call(drag(simulation));
                        g.append("circle")
                            .attr("class", d => `node ${d.type}`)
                            .classed('visited', d => visitedNodes.has(d.id))
                            .style("fill", "currentColor")
                            .attr("r", 0)
                            .call(s => s.transition().duration(750).delay((d, i) => i * 50).attr("r", d => radiusScale(d.degree)));
                        g.append("text")
                            .attr("class", "node-label")
                            .attr("dy", d => radiusScale(d.degree) + 12)
                            .text(d => d.id.split(':')[0])
                            .attr("opacity", 0)
                            .call(s => s.transition().delay(700).duration(750).attr("opacity", 1));
                        return g;
                    },
                    update => {
                        update.select('.node').classed('visited', d => visitedNodes.has(d.id));
                        return update;
                    },
                    exit => exit.transition().duration(500).attr("opacity", 0).remove()
                );

                link = link.data(links, d => `${d.source.id}-${d.target.id}`).join(
                    enter => enter.append("line")
                        .attr("class", "link")
                        .attr("stroke-width", 0)
                        .attr("stroke", d => { 
                            const sourceNode = d.source;
                            if (sourceNode.type === 'tesi') return 'var(--tesi-color)';
                            if (sourceNode.type === 'nota') return 'var(--nota-color)';
                            if (sourceNode.type === 'autore') return 'var(--autore-color)';
                            return 'var(--utente-color)';
                        })
                        .call(s => s.transition().delay(200).duration(750).attr("stroke-width", 1.5)),
                    update => update,
                    exit => exit.transition().duration(500).attr("stroke-width", 0).remove()
                );
                
                const linkedByIndex = {};
                links.forEach(d => { 
                    const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                    const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                    linkedByIndex[`${sourceId},${targetId}`] = 1; 
                });
                
                function areNodesConnected(a, b) {
                    return linkedByIndex[`${a.id},${b.id}`] || linkedByIndex[`${b.id},${a.id}`] || a.id === b.id;
                }

                nodeGroup.on('mouseover', function(event, d_hover) {
                    nodeGroup.classed('faded', n => !areNodesConnected(d_hover, n));
                    link.classed('faded', l => !(l.source.id === d_hover.id || l.target.id === d_hover.id));
                }).on('mouseout', function() {
                    nodeGroup.classed('faded', false);
                    link.classed('faded', false);
                }).on("click", (event, d) => {
                    event.stopPropagation();
                    windowManager.createWindow({ id: d.id, title: d.id, content: d.content });
                    updateHistory(d);
                });

                simulation.nodes(nodes);
                simulation.force("link").links(links);
                simulation.alpha(1).restart();
            }
            
            function expandGraph() {
                isFirstVisit = false;
                currentNodes = fullGraphData.nodes;
                currentLinks = fullGraphData.links;
                updateGraph(currentNodes, currentLinks);
            }
            
            container.call(d3.zoom().on("zoom", (event) => g.attr("transform", event.transform)));
            
            simulation.on("tick", () => { 
                link.attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                nodeGroup.attr("transform", d => `translate(${d.x},${d.y})`); 
            });

            function drag(simulation) { 
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.1).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }
            
                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }
            
                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
                
                return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended); 
            }
            
            function setupSimulationControls() {
                const repelSlider = document.getElementById('repel-force');
                const linkForceSlider = document.getElementById('link-force');
                const linkDistSlider = document.getElementById('link-distance');

                repelSlider.addEventListener('input', e => {
                    simulation.force("charge").strength(-e.target.value);
                    simulation.alpha(0.3).restart();
                });
                linkForceSlider.addEventListener('input', e => {
                    simulation.force("link").strength(+e.target.value);
                    simulation.alpha(0.3).restart();
                });
                linkDistSlider.addEventListener('input', e => {
                    simulation.force("link").distance(+e.target.value);
                    simulation.alpha(0.3).restart();
                });
                
                simulation.force("charge").strength(-repelSlider.value);
                simulation.force("link").strength(+linkForceSlider.value).distance(+linkDistSlider.value);
            }

            // --- INIZIALIZZAZIONE ---
            
            // NUOVA IMPLEMENTAZIONE GOOGLE LOGIN: Esegui il controllo del token Google all'avvio
            handleGoogleAuthCallback();
            
            initializeGraph();
            updateUIAfterAuth(); 
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pannello Admin - Compost</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        :root {
            --dark-bg: #1a1a1a; --glass-bg: rgba(30, 30, 30, 0.9); --border-color: rgba(255, 255, 255, 0.1);
            --text-color: #f0f0f0; --text-muted: #ccc; --error-color: #FF4136; --success-color: #3D9970;
            --utente-color: #ADFF2F; --cyan-color: #00FFFF;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--dark-bg); color: var(--text-color); }
        .container { max-width: 900px; margin: 2rem auto; padding: 2rem; }
        .contribution-card { background-color: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1.5rem; padding: 1.5rem; }
        .contribution-header { border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .contribution-title { font-size: 1.5rem; font-weight: bold; color: var(--utente-color); }
        .contribution-meta { font-size: 0.9rem; color: var(--text-muted); }
        .contribution-content { line-height: 1.6; max-height: 200px; overflow-y: auto; background-color: #111; padding: 1rem; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; }
        .actions { margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end; }
        .btn { padding: 0.5rem 1rem; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-approve { background-color: var(--success-color); color: white; }
        .btn-reject { background-color: var(--error-color); color: white; }
        #main-title { color: var(--cyan-color); }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title" class="text-4xl font-bold mb-8">Pannello di Moderazione</h1>
        <div id="message-area" class="text-center p-4 mb-4 rounded-lg" style="display: none;"></div>
        <div id="contributions-list">
            <!-- I contributi verranno caricati qui -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'http://localhost:3000';
            const authToken = localStorage.getItem('jwtToken');
            const contributionsList = document.getElementById('contributions-list');
            const messageArea = document.getElementById('message-area');
            
            // --- NUOVA PARTE: URL DI REDIRECT SICURO ---
            const currentUrl = window.location.href;
            const redirectUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1) + 'index.html';
            // --- FINE NUOVA PARTE ---


            // Funzione per mostrare messaggi
            const showMessage = (text, type = 'info') => {
                messageArea.textContent = text;
                messageArea.style.display = 'block';
                messageArea.className = `text-center p-4 mb-4 rounded-lg ${type === 'error' ? 'bg-red-900 bg-opacity-50' : type === 'success' ? 'bg-green-900 bg-opacity-50' : 'bg-gray-700 bg-opacity-50'}`;
            };

            // Funzione per moderare un contributo
            const moderateContribution = async (nodeId, decision, cardElement) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/admin/moderate-node`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ nodeId, decision })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    
                    showMessage(data.message, 'success');
                    cardElement.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                    cardElement.style.opacity = '0';
                    cardElement.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        cardElement.remove();
                        // Se era l'ultimo, mostra il messaggio "nessun contributo"
                        if (contributionsList.children.length === 0) {
                             showMessage('Nessun contributo in attesa di revisione. Ottimo lavoro!', 'info');
                        }
                    }, 500);

                } catch (error) {
                    showMessage(`Errore durante la moderazione: ${error.message}`, 'error');
                }
            };

            // Funzione principale per caricare i dati
            const loadPendingContributions = async () => {
                if (!authToken) {
                    window.location.href = redirectUrl; // Reindirizza se non c'Ã¨ token
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/admin/pending-nodes`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.status === 403 || response.status === 401) {
                        showMessage('Accesso negato. Devi essere un amministratore per visualizzare questa pagina.', 'error');
                        setTimeout(() => window.location.href = redirectUrl, 3000);
                        return;
                    }

                    const contributions = await response.json();
                    if (contributions.length === 0) {
                        showMessage('Nessun contributo in attesa di revisione. Ottimo lavoro!', 'info');
                        return;
                    }

                    contributionsList.innerHTML = ''; // Pulisci la lista
                    contributions.forEach(c => {
                        const card = document.createElement('div');
                        card.className = 'contribution-card';
                        card.innerHTML = `
                            <div class="contribution-header">
                                <h2 class="contribution-title">${c.title}</h2>
                                <p class="contribution-meta">Inviato da: ${c.author_email} il ${new Date(c.created_at).toLocaleString('it-IT')}</p>
                            </div>
                            <div class="contribution-content">
                                <pre>${c.content}</pre>
                            </div>
                            <div class="actions">
                                <button class="btn btn-approve">Approva</button>
                                <button class="btn btn-reject">Rifiuta</button>
                            </div>
                        `;
                        contributionsList.appendChild(card);

                        // Aggiungi event listener ai pulsanti
                        card.querySelector('.btn-approve').addEventListener('click', () => moderateContribution(c.id, 'approved', card));
                        card.querySelector('.btn-reject').addEventListener('click', () => moderateContribution(c.id, 'rejected', card));
                    });

                } catch (error) {
                    showMessage(`Errore nel caricamento dei contributi: ${error.message}`, 'error');
                }
            };

            // Avvia l'applicazione
            loadPendingContributions();
        });
    </script>
</body>
</html>

